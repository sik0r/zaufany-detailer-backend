# Plan Implementacji - US-002: Rejestracja Firmy

Na podstawie historyjki użytkownika US-002 z `prd.md`.

## 1. Cel

Umożliwienie właścicielom warsztatów rejestracji ich firmy w systemie poprzez dedykowany formularz, stworzenie powiązanych rekordów firmy i pracownika (nieaktywnego) oraz poinformowanie użytkownika o konieczności manualnej aktywacji konta.

## 2. Encje

### Employee (Pracownik)

Reprezentuje użytkownika (pracownika) powiązanego z firmą.

*   `id`: `Uuid` (PK)
*   `email`: `string` (unique, not null)
*   `firstName`: `string` (not null)
*   `lastName`: `string` (not null)
*   `password`: `string` (not null, hashowane)
*   `phoneNumber`: `string` (nullable) - *PRD wspomina o telefonie firmy, tu przechowujemy telefon pracownika.*
*   `isActive`: `boolean` (not null, default: `false`)
*   `company`: `ManyToOne` relacja do `Company` (not null)
*   `createdAt`: `datetime_immutable` (not null)
*   `updatedAt`: `datetime_immutable` (nullable)

### Company (Firma)

Reprezentuje zarejestrowaną firmę.

*   `id`: `Uuid` (PK)
*   `name`: `string` (not null)
*   `nip`: `string` (unique, not null)
*   `regon`: `string` (not null)
*   `addressStreet`: `string` (not null)
*   `addressPostalCode`: `string` (not null)
*   `addressCity`: `string` (not null)
*   `owner`: `OneToOne` relacja do `Employee`
*   `createdAt`: `datetime_immutable` (not null)
*   `updatedAt`: `datetime_immutable` (nullable)

## 3. DTO (Data Transfer Object)

### RegisterCompanyRequestDto

Obiekt przenoszący dane z formularza rejestracyjnego i podlegający walidacji.

*   `companyName`: `string`
*   `employeeFirstName`: `string`
*   `employeeLastName`: `string`
*   `nip`: `string`
*   `regon`: `string`
*   `email`: `string`
*   `phoneNumber`: `string`
*   `companyStreet`: `string`
*   `companyPostalCode`: `string`
*   `companyCity`: `string`
*   `password`: `string` (plain text)
*   `passwordConfirm`: `string` (plain text)
*   `termsAccepted`: `bool`

## 4. Routing

*   `GET /dla-warsztatu/zaloz-konto` -> `WorkshopRegistrationController::showForm` (nazwa routingu: `workshop_register_form`)
*   `POST /dla-warsztatu/zaloz-konto` -> `WorkshopRegistrationController::handleRegistration` (nazwa routingu: `workshop_register_handle`)
*   `GET /dla-warsztatu/zaloz-konto/dziekujemy` -> `WorkshopRegistrationController::showThankYou` (nazwa routingu: `workshop_register_thankyou`)

## 5. Kontroler (`src/Controller/Frontend/WorkshopRegistrationController.php`)

*   **`showForm()`**: Wyświetla formularz rejestracyjny (`dla-warsztatu/register.html.twig`).
*   **`handleRegistration(Request $request, CompanyRegistrationService $registrationService)`**:
    *   Tworzy instancję `RegisterCompanyRequestDto` z danych żądania.
    *   Tworzy formularz Symfony typu `RegistrationFormType` powiązany z DTO.
    *   Obsługuje żądanie (`$form->handleRequest($request)`).
    *   Sprawdza, czy formularz został wysłany i jest poprawny (`$form->isSubmitted() && $form->isValid()`).
    *   Jeśli tak:
        *   Wywołuje `CompanyRegistrationService::registerCompany($dto)`.
        *   Przekierowuje na stronę podziękowania (`workshop_register_thankyou`).
    *   Jeśli nie:
        *   Renderuje ponownie widok formularza z błędami walidacji.
*   **`showThankYou()`**: Wyświetla stronę z podziękowaniem za rejestrację (`dla-warsztatu/thank_you.html.twig`).

## 6. Serwis (`src/Service/Workshop/CompanyRegistrationService.php`)

*   **`registerCompany(RegisterCompanyRequestDto $dto)`**:
    *   Sprawdza unikalność `nip` i `email` w bazie danych (rzuca wyjątki w razie konfliktu, np. `DuplicateNipException`, `DuplicateEmailException`).
    *   Tworzy nową instancję `Company` na podstawie danych z DTO.
    *   Tworzy nową instancję `Employee`.
        *   Ustawia `isActive` na `false`.
        *   Hashuje hasło (`password`) z DTO przy użyciu `UserPasswordHasherInterface`.
        *   Ustawia pozostałe dane pracownika z DTO.
    *   Ustawia relację: `$employee->setCompany($company)`.
    *   Zapisuje obie encje do bazy danych (`EntityManagerInterface::persist()`, `EntityManagerInterface::flush()`).

## 7. Widoki (Templates)

*   **`templates/frontend/dla_warsztatow/register.html.twig`**:
    *   Zawiera formularz HTML zbudowany przy użyciu `form_start()`, `form_widget()`, `form_errors()`, `form_end()`.
    *   Wyświetla pola zgodnie z `RegisterCompanyRequestDto`.
    *   Zawiera pole checkbox dla akceptacji regulaminu (`termsAccepted`).
    *   Implementuje ochronę CSRF (automatycznie przez Symfony Forms).
*   **`templates/frontend/dla_warsztatow/thank_you.html.twig`**:
    *   Wyświetla komunikat o pomyślnej rejestracji i konieczności oczekiwania na aktywację konta przez administratora.

## 8. Walidacja

Zdefiniowana jako atrybuty/constraints w `RegisterCompanyRequestDto`:

*   Wszystkie pola tekstowe: `Assert\NotBlank`
*   `email`: `Assert\Email`, `Assert\NotBlank`, `UniqueEntity` (dla `Employee.email` - wymaga utworzenia customowego walidatora lub obsługi w serwisie przed zapisem)
*   `nip`: `Assert\NotBlank`, `Assert\Length(10)`, Custom Validator (np. `NipChecksumValidator`) sprawdzający sumę kontrolną, `UniqueEntity` (dla `Company.nip` - j.w.)
*   `regon`: `Assert\NotBlank`, `Assert\Length(min=9, max=14)`, Custom Validator (np. `RegonChecksumValidator`) sprawdzający sumę kontrolną.
*   `password`: `Assert\NotBlank`, `Assert\Length(min=8)` (lub inne reguły złożoności)
*   `passwordConfirm`: `Assert\NotBlank`, `Assert\EqualTo(propertyPath="password", message="Hasła muszą być identyczne.")`
*   `termsAccepted`: `Assert\IsTrue(message="Musisz zaakceptować regulamin.")`

## 9. Bezpieczeństwo

*   Użycie `UserPasswordHasherInterface` do bezpiecznego hashowania haseł.
*   Włączenie ochrony CSRF dla formularza rejestracji.
*   Walidacja unikalności NIP i e-mail po stronie serwera przed zapisem do bazy.

## 10. Migracje

*   Utworzenie migracji Doctrine (`make:migration`) w celu stworzenia tabel `company` i `employee` w bazie danych zgodnie ze zdefiniowanymi encjami.

## 11. Testy

*   **Testy jednostkowe (Unit Tests)**:
    *   `CompanyRegistrationService` (mockując zależności jak EntityManager, PasswordHasher, sprawdzając logikę tworzenia encji, hashowania, sprawdzania unikalności).
    *   Walidatory NIP/REGON (jeśli stworzono customowe).
*   **Testy funkcjonalne (Functional Tests)**:
    *   `WorkshopRegistrationController` (używając `WebTestCase`):
        *   Test poprawnego wyświetlania formularza (GET).
        *   Test poprawnego przesłania formularza (POST z poprawnymi danymi, sprawdzenie przekierowania, sprawdzenie utworzenia encji w DB).
        *   Test przesłania formularza z błędnymi danymi (np. brakujące pola, niepoprawny email/NIP/REGON, różne hasła, niezaakceptowany regulamin - sprawdzenie renderowania błędów).
        *   Test próby rejestracji z zajętym NIP/e-mailem.
        *   Test poprawnego wyświetlania strony podziękowania (GET).

## 12. Kroki Implementacji (Sugerowana Kolejność)

1.  Definicja encji `Company` i `Employee`.
2.  Utworzenie migracji Doctrine i aktualizacja schematu bazy danych.
3.  Implementacja `RegisterCompanyRequestDto` z podstawowymi constraintami walidacji (`NotBlank`, `Email`, `Length`, `EqualTo`, `IsTrue`).
4.  Implementacja `WorkshopRegistrationController` (routing, akcje `showForm`, `handleRegistration`, `showThankYou` - na razie bez logiki serwisowej).
5.  Stworzenie widoków Twig (`register.html.twig`, `thank_you.html.twig`) i formularza `RegistrationFormType`.
6.  Implementacja `CompanyRegistrationService` (wstrzyknięcie zależności, logika tworzenia encji, hashowanie hasła, zapis do DB - bez sprawdzania unikalności na razie).
7.  Integracja `CompanyRegistrationService` z `WorkshopRegistrationController`.
8.  Implementacja sprawdzania unikalności NIP i e-mail (w serwisie lub przez customowe walidatory/`UniqueEntity`).
9.  Implementacja customowych walidatorów dla sum kontrolnych NIP/REGON.
10. Dopracowanie walidacji w DTO (dodanie `UniqueEntity` lub obsługa wyjątków z serwisu w kontrolerze).
11. Napisanie testów jednostkowych i funkcjonalnych.
12. Refaktoryzacja i weryfikacja zgodności z `backend-guidelines.mdc`. 